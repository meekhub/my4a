CREATE TABLE MID_JF_INCOME_ZZ_01
(
ACCEPT_PERSON VARCHAR2(100),
DEALER_ID  VARCHAR2(100), 
ACCEPT_DATE date,
COMPLETE_DATE date,
CUST_ORDER_ID  VARCHAR2(100)
)

CREATE TABLE MID_JF_INCOME_ZZ_02
(
EFF_ORDER_ITEM_ID VARCHAR2(100),
PROD_OFFER_INST_ID  VARCHAR2(100), 
PROD_OFFER_ID  VARCHAR2(100), 
PKG_FEE number 
)

CREATE TABLE MID_JF_INCOME_ZZ_03
(
ORDER_ITEM_ID VARCHAR2(100),
CUST_ORDER_ID VARCHAR2(100)
)


--当月受理信息
INSERT INTO MID_JF_INCOME_ZZ_01 
  SELECT ACCEPT_PERSON,
         DEALER_ID,
         ACCEPT_DATE,
         COMPLETE_DATE,
         CUST_ORDER_ID,
         USER_ID
    FROM CRM_DSG.BB_BUS_INFO_T@HBODS T
   WHERE HOME_CITY = '188'
     AND ACCEPT_DATE >= TO_DATE('201710', 'YYYYMM')
     AND ACCEPT_DATE < ADD_MONTHS(TO_DATE('201710', 'YYYYMM'), 1)


--找到实例对应的订单 eff_order_item_id
INSERT INTO MID_JF_INCOME_ZZ_02
SELECT B.EFF_ORDER_ITEM_ID,
       B.PROD_OFFER_INST_ID,
       B.PROD_OFFER_ID,
       A.PKG_FEE
  FROM DIM.DIM.DIM_PRODUCT_CL A
  LEFT JOIN (SELECT EFF_ORDER_ITEM_ID, PROD_OFFER_INST_ID, PROD_OFFER_ID
               FROM STAGE.PROD_OFFER_INST A
              WHERE A.CITY_CODE = '188'
                AND TO_CHAR(EFF_DATE, 'YYYYMM') = '201710'
                AND A.PROD_OFFER_TYPE = '12') B
    ON A.PKG_ID = B.PROD_OFFER_ID


--订单表
INSERT INTO MID_JF_INCOME_ZZ_03
SELECT ORDER_ITEM_ID, CUST_ORDER_ID
  FROM CRM_DSG.ORDER_ITEM@HBODS
 WHERE CITY_CODE = C1.AREA_NO
   AND STATUS_DATE >= TO_DATE('201710', 'YYYYMM')
   AND STATUS_DATE < ADD_MONTHS(TO_DATE('201710', 'YYYYMM'), 1);
   


INSERT INTO MID_JF_INCOME_ZZ_04
SELECT USER_ID, DEALER_ID, PKG_FEE
  FROM (SELECT A.USER_ID,
               A.DEALER_ID,
               C.PKG_FEE,
               C.PROD_OFFER_ID,
               ROW_NUMBER() OVER(PARTITION BY A.USER_ID, A.DEALER_ID ORDER BY A.COMPLETE_DATE DESC) RN
          FROM MID_JF_INCOME_ZZ_01 A
          LEFT JOIN MID_JF_INCOME_ZZ_03 B
            ON A.CUST_ORDER_ID = B.CUST_ORDER_ID
          LEFT JOIN MID_JF_INCOME_ZZ_02 C
            ON B.ORDER_ITEM_ID = C.EFF_ORDER_ITEM_ID)
 WHERE RN = 1

   
   
   
