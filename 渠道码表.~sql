create table tmp_majh_0703_01 as 
select * from 
(
SELECT T.*, 
(CASE 
WHEN SUBSTR(T.ZHIJU_ID, -4) <> '9999' THEN 
1 
WHEN (T.BUSI_ZONE_CHANGE IS NULL AND T.BUSINESS_ZONE LIKE '20%') OR 
(T.BUSI_ZONE_CHANGE IS NOT NULL AND 
T.BIZ_ZONE_LEVEL IN ('10', '20', '30')) THEN 
2 
ELSE 
3 
END) KPI_NO, 
(CASE 
WHEN SUBSTR(T.ZHIJU_ID, -4) <> '9999' THEN 
'支局' 
WHEN (T.BUSI_ZONE_CHANGE IS NULL AND T.BUSINESS_ZONE LIKE '20%') OR 
(T.BUSI_ZONE_CHANGE IS NOT NULL AND 
T.BIZ_ZONE_LEVEL IN ('10', '20', '30')) THEN 
'商圈' 
ELSE 
'非商圈' 
END) KPI_NAME, 
CASE 
WHEN T.AREA_NO = '179' THEN 
'187' 
ELSE 
T.AREA_NO 
END AREA_NO_NEW, 
CASE 
WHEN T.CHANNEL_TYPE IN ('110101', '110102', '110103') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'005' 
WHEN T.CHANNEL_TYPE IN ('110201') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'1100' 
WHEN T.CHANNEL_TYPE IN ('110301') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'001' 
WHEN T.CHANNEL_TYPE IN ('110302') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'002' 
WHEN (T.CHANNEL_TYPE NOT IN 
('110101', '110102', '110103', '110201', '110301', '110302') OR 
T.CHANNEL_TYPE IS NULL) AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' AND 
T.PROTOP10 IN ('1', '2') THEN 
'003' 
WHEN (T.CHANNEL_TYPE NOT IN 
('110101', '110102', '110103', '110201', '110301', '110302') OR 
T.CHANNEL_TYPE IS NULL) AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' AND 
(T.PROTOP10 NOT IN ('1', '2') OR T.PROTOP10 IS NULL) THEN 
'004' 
ELSE 
'' 
END REPORT_CHANNEL_KIND_NEW, 
CASE 
WHEN T.CHANNEL_TYPE IN ('110101', '110102', '110103') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'自营厅' 
WHEN T.CHANNEL_TYPE IN ('110201') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'专营店' 
WHEN T.CHANNEL_TYPE IN ('110301') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'国家连锁' 
WHEN T.CHANNEL_TYPE IN ('110302') AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' THEN 
'省级连锁' 
WHEN (T.CHANNEL_TYPE NOT IN 
('110101', '110102', '110103', '110201', '110301', '110302') OR 
T.CHANNEL_TYPE IS NULL) AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' AND 
T.PROTOP10 IN ('1', '2') THEN 
'省市TOP' 
WHEN (T.CHANNEL_TYPE NOT IN 
('110101', '110102', '110103', '110201', '110301', '110302') OR 
T.CHANNEL_TYPE IS NULL) AND 
SUBSTR(T.CHANNEL_TYPE, 1, 2) = '11' AND 
(T.PROTOP10 NOT IN ('1', '2') OR T.PROTOP10 IS NULL) THEN 
'中小混营' 
ELSE 
'' 
END REPORT_CHANNEL_NAME_NEW 
FROM RPT_HBTELE.DM_BUSI_CHANNEL_BUILD_D T 
WHERE T.ACCT_MONTH = '201606' 
AND T.DAY_ID = '17'
)
where kpi_name='商圈'
;

select count(*),a.channel_type,c.channel_type_desc from dim.dim_channel_no a,tmp_majh_0703_01 b,dim.dim_channel_type c
where a.channel_no=b.channel_no and a.channel_type=c.channel_type
and a.valid_status=1
group by a.channel_type,c.channel_type_desc




























